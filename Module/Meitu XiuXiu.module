#!name=Meitu XiuXiu VIP Unlock â€“ Nightmarket Edition
# desc=ðŸ’¬ Chá»‰ fake VIP + má»Ÿ pháº§n OFFLINE (filter, sticker, frameâ€¦)
# ðŸ’¬ Discord: https://discord.gg/juY9tw5AJY
# ðŸš€ Released by: Nightmarket Server
// ðŸ‘¤ Mod by: Nightmarket
// âš ï¸ KhÃ´ng unlock AI / cloud Ä‘á»ƒ trÃ¡nh app lá»—i

let url = $request.url;
let body = $response.body;

try {
  let obj = JSON.parse(body);

  // Helper: gÃ¡n tráº¡ng thÃ¡i VIP â€œÄ‘áº¹p vÃ  an toÃ nâ€
  function applyVIP(data) {
    if (!data || typeof data !== "object") return;

    data.is_vip = true;
    data.vip_type = 4;          // 4 = kiá»ƒu VIP cao (Gold)
    data.old_vip_type = 4;
    data.sub_type = 8;          // 8 = gÃ³i nÄƒm
    data.is_expire = 0;         // 0 = chÆ°a háº¿t háº¡n
    data.expire_days = -999;    // ngÃ y Ã¢m = khÃ´ng quan trá»ng nhÆ°ng trÃ¡nh bá»‹ check ká»³
    data.valid_time = 4070880000;   // timestamp ~ 2099
    data.invalid_time = 0;
    data.screen_name = "Nightmarket VIP";
  }

  // 1. Chi tiáº¿t VIP (trang sub detail)
  if (url.includes("/v1/h5/vip/sub_detail")) {
    if (obj.data) applyVIP(obj.data);
  }

  // 2. ThÃ´ng tin tÃ i khoáº£n (Meitu thÆ°á»ng check VIP á»Ÿ Ä‘Ã¢y)
  if (url.includes("/v1/account/verify_credentials")) {
    if (obj.data) {
      applyVIP(obj.data);
      obj.data.free_trial = 1;      // Ä‘Ã¡nh dáº¥u tá»«ng dÃ¹ng trial, trÃ¡nh bug
    }
  }

  // 3. Má»™t sá»‘ API khÃ¡c vá» sub_info (náº¿u cÃ³)
  if (url.includes("/v1/h5/vip/sub_info")) {
    if (obj.data) applyVIP(obj.data);
  }

  // 4. Trang home VIP â€“ chá»‰ chá»‰nh text, khÃ´ng Ä‘á»™ng vÃ o logic
  if (url.includes("/v1/h5/vip/home")) {
    // Má»™t sá»‘ báº£n tráº£ vá» dáº¡ng { data: {...} }, má»™t sá»‘ lÃ  key trá»±c tiáº¿p
    let target = obj.data || obj;

    if (target) {
      target.home_prompt = "VIP cá»§a báº¡n sáº½ háº¿t háº¡n vÃ o 2099/01/01.";
      target.home_btn_prompt = "";
      target.beautify_btn_prompt = "";
      target.beautify_prompt = "";
    }
  }

  body = JSON.stringify(obj);
} catch (e) {
  // Náº¿u parse lá»—i thÃ¬ tráº£ body gá»‘c cho an toÃ n
  console.log("Meitu VIP Nightmarket: JSON parse error -> fallback original");
}

$done({ body });
